generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============= ENUMS =============

enum UserRole {
  ADMIN
  AGENT
  USER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum Platform {
  FACEBOOK
  GOOGLE
  TIKTOK
  SNAPCHAT
  BING
}

enum AccountStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
  REFUNDED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  REFUND
  TRANSFER
  CREDIT
}

enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum PayLinkType {
  INDIVIDUAL
  COMPANY
}

enum PayLinkStatus {
  ACTIVE
  INACTIVE
}

enum PayLinkRequestStatus {
  PENDING
  LINK_CREATED
  COMPLETED
  REJECTED
}

enum PayLinkRequestType {
  INDIVIDUAL
  COMPANY
}

enum DomainStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LicenseType {
  NEW
  OLD
}

enum CryptoNetwork {
  TRON_TRC20
  BSC_BEP20
}

// ============= MODELS =============

model User {
  id                String      @id @default(auto()) @map("_id") @db.ObjectId
  email             String      @unique
  password          String
  plaintextPassword String?
  username          String
  phone             String?
  phone2            String?
  realName          String?
  address           String?
  website           String?
  profileImage      String?
  uniqueId          String      @unique @default(cuid())

  role              UserRole    @default(USER)
  status            UserStatus  @default(ACTIVE)

  // Wallet
  walletBalance     Float       @default(0)
  openingFee        Float       @default(0)

  // Coupons (free ad account applications)
  couponBalance     Int         @default(0)

  // Platform fees (for agents)
  fbFee             Float       @default(0)
  fbCommission      Float       @default(0)
  fbUnlimitedDomainFee Float    @default(0)  // Extra fee when user selects "Unlimited Domain"
  googleFee         Float       @default(0)
  googleCommission  Float       @default(0)
  googleUnlimitedDomainFee Float @default(0)
  tiktokFee         Float       @default(0)
  tiktokCommission  Float       @default(0)
  tiktokUnlimitedDomainFee Float @default(0)
  snapchatFee       Float       @default(0)
  snapchatCommission Float      @default(0)
  snapchatUnlimitedDomainFee Float @default(0)
  bingFee           Float       @default(0)
  bingCommission    Float       @default(0)
  bingUnlimitedDomainFee Float  @default(0)

  // 2FA
  twoFactorEnabled  Boolean     @default(false)
  twoFactorSecret   String?
  twoFactorEmailCode    String?     // Email OTP code for 2FA login alternative
  twoFactorEmailExpiry  DateTime?   // Email OTP expiry (10 min)
  twoFactorEmailSentAt  DateTime?   // Rate limiting: 60s between sends

  // Email verification
  emailVerified     Boolean     @default(false)
  emailVerifyToken  String?
  emailVerifyExpiry DateTime?
  pendingEmail      String?     // New email pending verification during email change

  // Password reset
  passwordResetToken   String?     // One-time use token for password reset
  passwordResetExpiry  DateTime?   // Token expiry time
  requirePasswordChange Boolean   @default(false)  // Force user to change password on first login

  // Remarks
  personalRemarks   String?
  contactRemarks    String?

  // Whitelabel branding (for agents)
  brandLogo         String?
  emailLogo         String?   // Auto-generated optimized logo for emails
  brandName         String?
  favicon           String?   // Custom favicon for whitelabel (base64)
  emailSenderName           String?   // Custom email sender name for whitelabel (pending approval)
  emailSenderNameApproved   String?   // Approved email sender name (used in actual emails)
  emailSenderNameStatus     String?   @default("PENDING") // PENDING, APPROVED, REJECTED

  // SMTP Configuration (for whitelabel email)
  smtpEnabled       Boolean   @default(false)
  smtpHost          String?   // e.g., smtp.gmail.com
  smtpPort          Int?      // e.g., 587, 465
  smtpUsername      String?   // SMTP auth username
  smtpPassword      String?   // SMTP auth password
  smtpEncryption    String?   // "TLS", "SSL", "NONE"
  smtpFromEmail     String?   // e.g., noreply@agency.com

  // Agent Dashboard Settings
  showBalanceToAgent Boolean  @default(false)  // Whether to show ad account balances to this agent

  // Relations
  agentId           String?     @db.ObjectId
  agent             User?       @relation("AgentUsers", fields: [agentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users             User[]      @relation("AgentUsers")

  creatorId         String?     @db.ObjectId
  creator           User?       @relation("CreatedUsers", fields: [creatorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdUsers      User[]      @relation("CreatedUsers")

  // Related records
  adAccounts        AdAccount[]
  adAccountApplications AdAccountApplication[]
  deposits          Deposit[]
  withdrawals       Withdrawal[]
  refunds           Refund[]
  walletFlows       WalletFlow[]
  payLinks          PayLink[]
  payLinkRequests   PayLinkRequest[]
  bmShareRequests   BmShareRequest[]
  balanceTransfers  BalanceTransfer[]
  blockHistory      BlockHistory[]  @relation("BlockedUser")
  blockedByHistory  BlockHistory[]  @relation("BlockedBy")
  customDomains     CustomDomain[]  @relation("AgentDomains")

  // Referral system
  referralCode      String?     @unique  // User's own referral code
  referredBy        String?     @db.ObjectId  // Who referred this user
  referralEarnings  Float       @default(0)  // Total earned from referrals
  referrals         Referral[]  @relation("Referrals")

  // Notifications
  notifications     Notification[]

  // Agent Withdrawals (for agents to withdraw their earnings)
  agentWithdrawals  AgentWithdrawal[]

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model AdAccount {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId

  // Account Info
  platform          Platform
  accountId         String        // The actual ad account ID assigned by admin
  accountName       String
  licenseName       String?       // License name from the application
  bmId              String?       // User's Business Manager ID (for sharing)
  sourceBmId        String?       // Source BM where this account is from (e.g., "cheetah" or actual BM ID)
  timezone          String?
  currency          String        @default("USD")

  // Status
  status            AccountStatus @default(PENDING)

  // Financials
  totalDeposit      Float         @default(0)
  totalSpend        Float         @default(0)
  balance           Float         @default(0)

  // Owner
  userId            String        @db.ObjectId
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Application reference
  applicationId     String?       @db.ObjectId
  application       AdAccountApplication? @relation(fields: [applicationId], references: [id])

  // Documents
  documents         String?       // JSON array of document URLs

  // Remarks
  remarks           String?
  adminRemarks      String?

  // Related
  deposits          AccountDeposit[]
  refunds           AccountRefund[]
  transfersFrom     BalanceTransfer[] @relation("TransferFrom")
  transfersTo       BalanceTransfer[] @relation("TransferTo")

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

// Ad Account Application - User submits this to request new ad accounts
model AdAccountApplication {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  applyId           String            @unique // Format: AD{YYYYMMDD/YYYYDDMM}{7-digit random} based on license type

  // Platform
  platform          Platform

  // License Info
  licenseType       LicenseType       @default(NEW)
  licenseNo         String?
  pageUrls          String?           // JSON array or comma-separated
  isApp             String?           // App identifier if applicable
  shopifyShop       Boolean           @default(false)

  // Account Details - JSON array of {name, accountId} for multiple accounts in one application
  accountDetails    String?           // JSON: [{name: "Account 1", accountId: ""}]
  adAccountQty      Int               @default(1) // How many accounts requested (max 5)

  // Financials
  depositAmount     Float             @default(0)
  openingFee        Float             @default(0)
  platformFee       Float             @default(0) // % fee
  totalCost         Float             @default(0)

  // Status
  status            TransactionStatus @default(PENDING)

  // Owner
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Remarks
  remarks           String?
  adminRemarks      String?

  // Related ad accounts created from this application
  adAccounts        AdAccount[]

  approvedAt        DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model Deposit {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  applyId           String?           @unique // Format: WD{YYYYMMDD}{7-digit random}

  amount            Float
  status            TransactionStatus @default(PENDING)

  // Payment details
  paymentMethod     String?
  paymentProof      String?           // Base64 image data
  transactionId     String?

  // Crypto deposit fields (optional - only for crypto deposits)
  cryptoNetwork     CryptoNetwork?    // TRON_TRC20 or BSC_BEP20
  txHash            String?           // Blockchain transaction hash (unique to prevent double-credit)
  fromAddress       String?           // Sender's wallet address
  blockNumber       String?           // Block number of the transaction
  verifiedAt        DateTime?         // When the transaction was verified on blockchain

  // User
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Remarks
  remarks           String?
  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([txHash])
}

model Withdrawal {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  amount            Float
  status            TransactionStatus @default(PENDING)

  // Bank details
  bankName          String?
  accountNumber     String?
  accountHolderName String?
  ifscCode          String?

  // User
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Remarks
  remarks           String?
  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model Refund {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  amount            Float
  status            TransactionStatus @default(PENDING)

  // Related account
  platform          Platform
  accountId         String?

  // User
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Remarks
  reason            String?
  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model AccountDeposit {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  applyId           String?
  amount            Float
  status            TransactionStatus @default(PENDING)

  // Commission charged at time of deposit (stored for historical accuracy)
  commissionRate    Float             @default(0)  // % rate at time of deposit
  commissionAmount  Float             @default(0)  // calculated amount at time of deposit

  // Account
  adAccountId       String            @db.ObjectId
  adAccount         AdAccount         @relation(fields: [adAccountId], references: [id], onDelete: Cascade)

  // Remarks
  remarks           String?
  adminRemarks      String?

  // Recharge tracking
  rechargeStatus    String            @default("NONE")   // NONE | PENDING | IN_PROGRESS | COMPLETED | FAILED
  rechargeMethod    String            @default("NONE")   // NONE | CHEETAH | EXTENSION | MANUAL
  rechargeError     String?
  rechargeAttempts  Int               @default(0)
  rechargedAt       DateTime?
  rechargedBy       String?                               // ExtensionSession ID that completed it

  approvedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model AccountRefund {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  amount            Float
  status            TransactionStatus @default(PENDING)

  // Account
  adAccountId       String            @db.ObjectId
  adAccount         AdAccount         @relation(fields: [adAccountId], references: [id], onDelete: Cascade)

  // Remarks
  reason            String?
  adminRemarks      String?

  approvedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model BalanceTransfer {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  amount            Float
  status            TransactionStatus @default(PENDING)

  // From Account
  fromAccountId     String            @db.ObjectId
  fromAccount       AdAccount         @relation("TransferFrom", fields: [fromAccountId], references: [id], onDelete: Cascade)

  // To Account
  toAccountId       String            @db.ObjectId
  toAccount         AdAccount         @relation("TransferTo", fields: [toAccountId], references: [id], onDelete: Cascade)

  // User who initiated the transfer
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Remarks
  remarks           String?
  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model BmShareRequest {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  applyId           String            @unique // Format: BM{YYYYMMDD}{7-digit random}

  // Platform
  platform          Platform

  // Account Info
  adAccountId       String
  adAccountName     String
  bmId              String            // User's BM ID to share to

  // Status
  status            TransactionStatus @default(PENDING)

  // User
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Remarks
  message           String?
  adminRemarks      String?

  // Share tracking (for auto BM share)
  shareMethod       String?           // "CHEETAH", "SERVER", "EXTENSION"
  shareAttempts     Int               @default(0)
  shareError        String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model WalletFlow {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId

  type              TransactionType
  amount            Float
  balanceBefore     Float
  balanceAfter      Float

  // Reference
  referenceId       String?         // ID of related transaction
  referenceType     String?         // deposit, withdrawal, refund, etc.

  // User
  userId            String          @db.ObjectId
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  description       String?

  createdAt         DateTime        @default(now())
}

model PayLink {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId

  type              PayLinkType
  title             String
  description       String?

  // Bank details
  bankName          String?
  accountNumber     String?
  accountHolderName String?
  ifscCode          String?
  upiId             String?
  qrCode            String?       // QR code image URL

  status            PayLinkStatus @default(ACTIVE)

  // User
  userId            String        @db.ObjectId
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model PayLinkRequest {
  id                String              @id @default(auto()) @map("_id") @db.ObjectId
  applyId           String?             @unique // Format: PL{YYYYMMDD}{7-digit random}

  type              PayLinkRequestType
  fullName          String
  email             String
  country           String
  amount            Float

  // Company fields (optional, only for COMPANY type)
  companyName       String?
  website           String?

  // Pay Link created by admin
  payLink           String?

  status            PayLinkRequestStatus @default(PENDING)

  // User who created the request
  userId            String              @db.ObjectId
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Admin remarks
  adminRemarks      String?

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model BlockHistory {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  reason            String?

  // User who was blocked
  userId            String    @db.ObjectId
  user              User      @relation("BlockedUser", fields: [userId], references: [id], onDelete: Cascade)

  // Admin/Agent who blocked
  blockedById       String    @db.ObjectId
  blockedBy         User      @relation("BlockedBy", fields: [blockedById], references: [id], onDelete: Cascade)

  blockedAt         DateTime  @default(now())
  unblockedAt       DateTime?
}

model CustomDomain {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId

  domain            String        @unique
  status            DomainStatus  @default(PENDING)

  // DNS verification
  dnsVerified       Boolean       @default(false)
  verificationToken String?       // Token for DNS TXT record verification

  // Branding (logo submitted with domain, requires admin approval)
  brandLogo         String?       // Base64 logo submitted by agent
  emailLogo         String?       // Auto-generated optimized logo for emails
  favicon           String?       // Custom favicon for whitelabel (base64)

  // Agent who owns this domain
  agentId           String        @db.ObjectId
  agent             User          @relation("AgentDomains", fields: [agentId], references: [id], onDelete: Cascade)

  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

// Crypto Wallet Configuration for automated USDT deposits
model CryptoWalletConfig {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId

  network           CryptoNetwork @unique  // TRON_TRC20 or BSC_BEP20
  walletAddress     String                 // Hot wallet address to receive deposits
  contractAddress   String                 // USDT contract address on the network
  isEnabled         Boolean       @default(true)

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

// Generic key-value settings for API configs, feature flags, etc.
model Setting {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  key               String    @unique
  value             String    // JSON string for complex values
  description       String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// Business Manager Configuration for auto BM sharing
model SiteSettings {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  domain            String    @unique
  brandName         String
  logo              String?
  favicon           String?

  // Contact
  supportEmail      String?
  supportPhone      String?

  // Social
  facebookUrl       String?
  twitterUrl        String?
  instagramUrl      String?

  // Settings
  maintenanceMode   Boolean   @default(false)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Module {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  route             String
  label             String
  icon              String

  role              UserRole
  priority          Int       @default(1000)

  isActive          Boolean   @default(true)
}

model PaymentMethod {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  name              String
  description       String?
  icon              String    @default("ðŸ’³")

  // Crypto wallet address (for USDT TRC20 / BEP20)
  walletAddress     String?

  isEnabled         Boolean   @default(true)
  isDefault         Boolean   @default(false)

  sortOrder         Int       @default(0)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model GlobalSettings {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  // Pay Link feature toggle
  payLinkEnabled    Boolean   @default(true)

  // Platform Visibility Settings
  // "active" = visible and can apply, "stop" = visible but can't apply, "hidden" = completely hidden
  facebookStatus    String    @default("active")  // active | stop | hidden
  googleStatus      String    @default("active")
  tiktokStatus      String    @default("active")
  snapchatStatus    String    @default("active")
  bingStatus        String    @default("active")

  // System Facebook Token (for fetching ad account balances without user OAuth)
  // This should be a System User access token from the platform's Business Manager
  facebookSystemToken    String?

  // Profile Share Links (displayed to users for page sharing)
  facebookProfileShareLink String?   @default("https://www.facebook.com/profile/6adplatform")
  tiktokProfileShareLink   String?   @default("https://business.tiktok.com/share/6adplatform")

  // Referral Domain (used for generating referral links)
  referralDomain    String?   @default("https://ads.sixad.io")

  // Agent Balance Visibility (controls whether agents can see ad account balances)
  showBalanceToAgents Boolean @default(false)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// Facebook Profile - Store connected Facebook accounts
model FacebookProfile {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  // Facebook User Info
  facebookUserId    String    // Facebook user ID
  name              String    // User's name on Facebook
  email             String?   // User's email from Facebook

  // Access Token (encrypted/hashed in production)
  accessToken       String
  tokenExpiresAt    DateTime?

  // Status
  isActive          Boolean   @default(true)

  // Owner - the user in our system who connected this profile
  userId            String    @db.ObjectId

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  aiCampaigns       AICampaign[]

  @@unique([userId, facebookUserId]) // One user can't connect same FB profile twice
  @@index([userId])
}

// ============= AI CAMPAIGN SYSTEM =============

enum AICampaignStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  PAUSED
  COMPLETED
  FAILED
}

enum AICampaignObjective {
  ECOMMERCE_SALES
  LEAD_GENERATION
  WEBSITE_TRAFFIC
  BRAND_AWARENESS
  APP_INSTALLS
  VIDEO_VIEWS
  ENGAGEMENT
}

enum OptimizationRuleType {
  BUDGET_INCREASE
  BUDGET_DECREASE
  PAUSE_CAMPAIGN
  ACTIVATE_CAMPAIGN
  PAUSE_ADSET
  ACTIVATE_ADSET
  PAUSE_AD
  ADJUST_BID
  SCALE_WINNING
  KILL_LOSING
}

enum OptimizationStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTED
  FAILED
}

enum ScheduleFrequency {
  HOURLY
  EVERY_4_HOURS
  EVERY_6_HOURS
  EVERY_12_HOURS
  DAILY
  WEEKLY
}

// AI Campaign - Main campaign configuration created by AI wizard
model AICampaign {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId

  // Basic Info
  name                String
  description         String?
  objective           AICampaignObjective
  status              AICampaignStatus    @default(DRAFT)

  // Budget Settings
  dailyBudget         Float
  totalBudget         Float?
  spentAmount         Float               @default(0)
  currency            String              @default("USD")

  // Schedule
  startDate           DateTime
  endDate             DateTime?
  timezone            String              @default("UTC")

  // Targeting (JSON)
  targeting           String?             // JSON: {locations, ages, genders, interests, behaviors, customAudiences}

  // Creatives (JSON)
  creatives           String?             // JSON: [{type, headline, description, imageUrl, videoUrl, ctaType}]

  // Facebook Integration
  fbCampaignId        String?             // Created Facebook campaign ID
  fbAdAccountId       String              // Facebook ad account ID
  profileId           String              @db.ObjectId
  profile             FacebookProfile     @relation(fields: [profileId], references: [id])

  // AI Configuration
  aiOptimizationEnabled Boolean           @default(true)
  targetCPA           Float?              // Target Cost Per Acquisition
  targetROAS          Float?              // Target Return On Ad Spend

  // Owner
  userId              String              @db.ObjectId

  // Relations
  optimizationRules   OptimizationRule[]
  optimizationLogs    OptimizationLog[]
  performanceSnapshots PerformanceSnapshot[]
  schedules           CampaignSchedule[]

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([userId])
  @@index([profileId])
  @@index([status])
}

// Campaign Template - Pre-built templates for quick campaign creation
model CampaignTemplate {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId

  name                String
  description         String?
  objective           AICampaignObjective
  category            String              // e-commerce, lead-gen, traffic, etc.

  // Default Settings (JSON)
  defaultBudget       Float?
  defaultTargeting    String?             // JSON template
  defaultCreatives    String?             // JSON template
  optimizationRules   String?             // JSON: default rules to apply

  // Meta
  isActive            Boolean             @default(true)
  isSystem            Boolean             @default(false)  // System templates vs user-created
  usageCount          Int                 @default(0)

  // For user-created templates
  userId              String?             @db.ObjectId

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}

// Optimization Rule - Rules that AI uses to optimize campaigns
model OptimizationRule {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId

  name                String
  description         String?
  ruleType            OptimizationRuleType
  isActive            Boolean             @default(true)

  // Conditions (JSON) - When to trigger
  // Example: {"metric": "cpc", "operator": ">", "value": 2.5, "timeframe": "last_7d"}
  conditions          String

  // Actions (JSON) - What to do
  // Example: {"action": "decrease_budget", "value": 20, "unit": "percent"}
  actions             String

  // Execution Settings
  priority            Int                 @default(0)       // Higher = runs first
  cooldownHours       Int                 @default(24)      // Wait time between executions
  maxExecutionsPerDay Int                 @default(3)

  // Campaign relation
  campaignId          String              @db.ObjectId
  campaign            AICampaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Logs
  lastExecutedAt      DateTime?
  executionCount      Int                 @default(0)

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([campaignId])
}

// Optimization Log - History of all AI suggestions and actions
model OptimizationLog {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId

  // What was suggested
  ruleType            OptimizationRuleType
  title               String
  description         String

  // Current vs Suggested values
  currentValue        String?             // JSON: {"budget": 100, "cpc": 2.5}
  suggestedValue      String?             // JSON: {"budget": 80}

  // Impact prediction
  predictedImpact     String?             // JSON: {"metric": "cpc", "change": -15, "confidence": 0.85}

  // Status
  status              OptimizationStatus  @default(PENDING)

  // Execution details
  executedAt          DateTime?
  executedBy          String?             // "AI" or userId
  rejectionReason     String?

  // Results after execution
  actualImpact        String?             // JSON: measured results after execution

  // Relations
  campaignId          String              @db.ObjectId
  campaign            AICampaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Target entity (what's being optimized)
  targetType          String              // "campaign", "adset", "ad"
  targetId            String              // Facebook ID of the entity
  targetName          String?

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([campaignId])
  @@index([status])
  @@index([createdAt])
}

// Performance Snapshot - Historical performance data for ML analysis
model PerformanceSnapshot {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId

  // Metrics
  spend               Float               @default(0)
  impressions         Int                 @default(0)
  reach               Int                 @default(0)
  clicks              Int                 @default(0)
  conversions         Int                 @default(0)
  revenue             Float               @default(0)

  // Calculated Metrics
  ctr                 Float               @default(0)
  cpc                 Float               @default(0)
  cpm                 Float               @default(0)
  cpa                 Float               @default(0)
  roas                Float               @default(0)
  frequency           Float               @default(0)

  // Snapshot time
  snapshotDate        DateTime
  snapshotHour        Int?                // 0-23 for hourly snapshots

  // Campaign relation
  campaignId          String              @db.ObjectId
  campaign            AICampaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Optional: track specific entity
  entityType          String?             // "campaign", "adset", "ad"
  entityId            String?             // Facebook ID

  createdAt           DateTime            @default(now())

  @@index([campaignId])
  @@index([snapshotDate])
  @@index([campaignId, snapshotDate])
}

// Campaign Schedule - Scheduled actions for campaigns
model CampaignSchedule {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId

  name                String
  description         String?
  isActive            Boolean             @default(true)

  // Schedule Type
  frequency           ScheduleFrequency

  // Time settings (for daily/weekly)
  runAtHour           Int?                // 0-23
  runAtMinute         Int?                // 0-59
  runOnDays           String?             // JSON: [1,2,3,4,5] for Mon-Fri

  // Action to perform (JSON)
  // Example: {"type": "adjust_budget", "value": {"morning": 120, "afternoon": 100, "evening": 80}}
  action              String

  // Campaign relation
  campaignId          String              @db.ObjectId
  campaign            AICampaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Execution tracking
  lastRunAt           DateTime?
  nextRunAt           DateTime?
  runCount            Int                 @default(0)

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([campaignId])
  @@index([nextRunAt])
}

// AI Analysis Result - Stores ML model predictions and recommendations
model AIAnalysisResult {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId

  // Analysis Type
  analysisType        String              // "performance_prediction", "audience_recommendation", "budget_optimization", "creative_analysis"

  // Input data (JSON)
  inputData           String

  // Output/Recommendations (JSON)
  recommendations     String              // JSON array of recommendations
  confidence          Float               // 0-1 confidence score

  // Model info
  modelVersion        String?

  // Relations
  campaignId          String?             @db.ObjectId
  userId              String              @db.ObjectId

  createdAt           DateTime            @default(now())

  @@index([userId])
  @@index([campaignId])
  @@index([analysisType])
}

// ============= REFERRAL SYSTEM =============

model Referral {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  // Referrer (user who invited)
  referrerId        String    @db.ObjectId
  referrer          User      @relation("Referrals", fields: [referrerId], references: [id], onDelete: Cascade)

  // Referred user (new user who signed up)
  referredUserId    String    @db.ObjectId

  // Referral code used
  referralCode      String

  // Reward tracking
  rewardAmount      Float     @default(0)  // Amount earned from this referral
  rewardPaid        Boolean   @default(false)
  rewardPaidAt      DateTime?

  // Status
  status            String    @default("pending")  // pending, qualified, rewarded

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([referrerId])
  @@index([referredUserId])
  @@index([referralCode])
}

// ============= NOTIFICATION SYSTEM =============

enum NotificationType {
  ACCOUNT_APPROVED
  ACCOUNT_REJECTED
  DEPOSIT_APPROVED
  DEPOSIT_REJECTED
  LOW_BALANCE
  REFUND_PROCESSED
  REFERRAL_REWARD
  SYSTEM
  ANNOUNCEMENT
}

model Notification {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  // Target user
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification content
  type              NotificationType
  title             String
  message           String
  link              String?           // Optional link to navigate to

  // Read status
  isRead            Boolean           @default(false)
  readAt            DateTime?

  // Metadata (JSON for extra data)
  metadata          String?

  createdAt         DateTime          @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============= ANNOUNCEMENT SYSTEM =============

model Announcement {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  // Content
  title             String
  message           String
  type              String    @default("info")  // info, warning, success, error

  // Display settings
  isActive          Boolean   @default(true)
  isPinned          Boolean   @default(false)
  showOnce          Boolean   @default(false)  // If true, show only once per user
  startDate         DateTime  @default(now())
  endDate           DateTime?

  // Target audience
  targetRole        String?   // USER, AGENT, ALL (null = all users)

  // Created by
  createdById       String    @db.ObjectId

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

// ============= LIVE CHAT SYSTEM =============

model ChatRoom {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId

  // Participants
  userId            String        @db.ObjectId
  adminId           String?       @db.ObjectId  // Assigned admin (null = unassigned)

  // Room status
  status            String        @default("open")  // open, assigned, closed

  // Last activity
  lastMessageAt     DateTime      @default(now())

  // Messages
  messages          ChatMessage[]

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([userId])
  @@index([adminId])
  @@index([status])
  @@index([lastMessageAt])
}

model ChatMessage {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  // Room
  roomId            String    @db.ObjectId
  room              ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Sender
  senderId          String    @db.ObjectId
  senderRole        String    // USER, ADMIN

  // Message content
  message           String
  attachmentUrl     String?
  attachmentType    String?   // image, file

  // Read status
  isRead            Boolean   @default(false)
  readAt            DateTime?

  createdAt         DateTime  @default(now())

  @@index([roomId])
  @@index([senderId])
  @@index([createdAt])
}

// ============= AGENT WITHDRAWAL SYSTEM =============

model AgentWithdrawal {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  amount            Float             // Original requested amount by agent
  approvedAmount    Float?            // Amount approved by admin (can be different from requested)
  status            TransactionStatus @default(PENDING)

  // Payment address/details
  paymentAddress    String?           // Crypto address, bank details, etc.
  paymentMethod     String?           // USDT_TRC20, BANK_TRANSFER, etc.

  // Agent (only agents can create withdrawals)
  agentId           String            @db.ObjectId
  agent             User              @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Description/Remarks
  description       String?
  adminRemarks      String?

  // Timestamps
  approvedAt        DateTime?
  rejectedAt        DateTime?
  clearedAt         DateTime?         // When funds were actually transferred

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([agentId])
  @@index([status])
  @@index([createdAt])
}

