generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============= ENUMS =============

enum UserRole {
  ADMIN
  AGENT
  USER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum Platform {
  FACEBOOK
  GOOGLE
  TIKTOK
  SNAPCHAT
  BING
}

enum AccountStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
  REFUNDED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  REFUND
  TRANSFER
  CREDIT
}

enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum PayLinkType {
  INDIVIDUAL
  COMPANY
}

enum PayLinkStatus {
  ACTIVE
  INACTIVE
}

enum PayLinkRequestStatus {
  PENDING
  LINK_CREATED
  COMPLETED
  REJECTED
}

enum PayLinkRequestType {
  INDIVIDUAL
  COMPANY
}

enum DomainStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LicenseType {
  NEW
  OLD
}

// ============= MODELS =============

model User {
  id                String      @id @default(auto()) @map("_id") @db.ObjectId
  email             String      @unique
  password          String
  plaintextPassword String?
  username          String
  phone             String?
  phone2            String?
  realName          String?
  address           String?
  website           String?
  profileImage      String?
  uniqueId          String      @unique @default(cuid())

  role              UserRole    @default(USER)
  status            UserStatus  @default(ACTIVE)

  // Wallet
  walletBalance     Float       @default(0)
  openingFee        Float       @default(0)

  // Coupons (free ad account applications)
  couponBalance     Int         @default(0)

  // Platform fees (for agents)
  fbFee             Float       @default(0)
  fbCommission      Float       @default(0)
  googleFee         Float       @default(0)
  googleCommission  Float       @default(0)
  tiktokFee         Float       @default(0)
  tiktokCommission  Float       @default(0)
  snapchatFee       Float       @default(0)
  snapchatCommission Float      @default(0)
  bingFee           Float       @default(0)
  bingCommission    Float       @default(0)

  // 2FA
  twoFactorEnabled  Boolean     @default(false)
  twoFactorSecret   String?

  // Remarks
  personalRemarks   String?
  contactRemarks    String?

  // Whitelabel branding (for agents)
  brandLogo         String?
  brandName         String?

  // Relations
  agentId           String?     @db.ObjectId
  agent             User?       @relation("AgentUsers", fields: [agentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users             User[]      @relation("AgentUsers")

  creatorId         String?     @db.ObjectId
  creator           User?       @relation("CreatedUsers", fields: [creatorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdUsers      User[]      @relation("CreatedUsers")

  // Related records
  adAccounts        AdAccount[]
  adAccountApplications AdAccountApplication[]
  deposits          Deposit[]
  withdrawals       Withdrawal[]
  refunds           Refund[]
  walletFlows       WalletFlow[]
  payLinks          PayLink[]
  payLinkRequests   PayLinkRequest[]
  bmShareRequests   BmShareRequest[]
  balanceTransfers  BalanceTransfer[]
  blockHistory      BlockHistory[]  @relation("BlockedUser")
  blockedByHistory  BlockHistory[]  @relation("BlockedBy")
  customDomains     CustomDomain[]  @relation("AgentDomains")

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model AdAccount {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId

  // Account Info
  platform          Platform
  accountId         String        // The actual ad account ID assigned by admin
  accountName       String
  licenseName       String?       // License name from the application
  bmId              String?       // Business Manager ID
  timezone          String?
  currency          String        @default("USD")

  // Status
  status            AccountStatus @default(PENDING)

  // Financials
  totalDeposit      Float         @default(0)
  totalSpend        Float         @default(0)
  balance           Float         @default(0)

  // Owner
  userId            String        @db.ObjectId
  user              User          @relation(fields: [userId], references: [id])

  // Application reference
  applicationId     String?       @db.ObjectId
  application       AdAccountApplication? @relation(fields: [applicationId], references: [id])

  // Documents
  documents         String?       // JSON array of document URLs

  // Remarks
  remarks           String?
  adminRemarks      String?

  // Related
  deposits          AccountDeposit[]
  refunds           AccountRefund[]
  transfersFrom     BalanceTransfer[] @relation("TransferFrom")
  transfersTo       BalanceTransfer[] @relation("TransferTo")

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

// Ad Account Application - User submits this to request new ad accounts
model AdAccountApplication {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  applyId           String            @unique // Format: AD{YYYYMMDD/YYYYDDMM}{7-digit random} based on license type

  // Platform
  platform          Platform

  // License Info
  licenseType       LicenseType       @default(NEW)
  licenseNo         String?
  pageUrls          String?           // JSON array or comma-separated
  isApp             String?           // App identifier if applicable
  shopifyShop       Boolean           @default(false)

  // Account Details - JSON array of {name, accountId} for multiple accounts in one application
  accountDetails    String?           // JSON: [{name: "Account 1", accountId: ""}]
  adAccountQty      Int               @default(1) // How many accounts requested (max 5)

  // Financials
  depositAmount     Float             @default(0)
  openingFee        Float             @default(0)
  platformFee       Float             @default(0) // % fee
  totalCost         Float             @default(0)

  // Status
  status            TransactionStatus @default(PENDING)

  // Owner
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id])

  // Remarks
  remarks           String?
  adminRemarks      String?

  // Related ad accounts created from this application
  adAccounts        AdAccount[]

  approvedAt        DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model Deposit {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  applyId           String?           @unique // Format: WD{YYYYMMDD}{7-digit random}

  amount            Float
  status            TransactionStatus @default(PENDING)

  // Payment details
  paymentMethod     String?
  paymentProof      String?           // Base64 image data
  transactionId     String?

  // User
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id])

  // Remarks
  remarks           String?
  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model Withdrawal {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  amount            Float
  status            TransactionStatus @default(PENDING)

  // Bank details
  bankName          String?
  accountNumber     String?
  accountHolderName String?
  ifscCode          String?

  // User
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id])

  // Remarks
  remarks           String?
  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model Refund {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  amount            Float
  status            TransactionStatus @default(PENDING)

  // Related account
  platform          Platform
  accountId         String?

  // User
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id])

  // Remarks
  reason            String?
  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model AccountDeposit {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  amount            Float
  status            TransactionStatus @default(PENDING)

  // Account
  adAccountId       String            @db.ObjectId
  adAccount         AdAccount         @relation(fields: [adAccountId], references: [id])

  // Remarks
  remarks           String?
  adminRemarks      String?

  approvedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model AccountRefund {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  amount            Float
  status            TransactionStatus @default(PENDING)

  // Account
  adAccountId       String            @db.ObjectId
  adAccount         AdAccount         @relation(fields: [adAccountId], references: [id])

  // Remarks
  reason            String?
  adminRemarks      String?

  approvedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model BalanceTransfer {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId

  amount            Float
  status            TransactionStatus @default(PENDING)

  // From Account
  fromAccountId     String            @db.ObjectId
  fromAccount       AdAccount         @relation("TransferFrom", fields: [fromAccountId], references: [id])

  // To Account
  toAccountId       String            @db.ObjectId
  toAccount         AdAccount         @relation("TransferTo", fields: [toAccountId], references: [id])

  // User who initiated the transfer
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id])

  // Remarks
  remarks           String?
  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model BmShareRequest {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  applyId           String            @unique // Format: BM{YYYYMMDD}{7-digit random}

  // Platform
  platform          Platform

  // Account Info
  adAccountId       String
  adAccountName     String
  bmId              String            // User's BM ID to share to

  // Status
  status            TransactionStatus @default(PENDING)

  // User
  userId            String            @db.ObjectId
  user              User              @relation(fields: [userId], references: [id])

  // Remarks
  message           String?
  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model WalletFlow {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId

  type              TransactionType
  amount            Float
  balanceBefore     Float
  balanceAfter      Float

  // Reference
  referenceId       String?         // ID of related transaction
  referenceType     String?         // deposit, withdrawal, refund, etc.

  // User
  userId            String          @db.ObjectId
  user              User            @relation(fields: [userId], references: [id])

  description       String?

  createdAt         DateTime        @default(now())
}

model PayLink {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId

  type              PayLinkType
  title             String
  description       String?

  // Bank details
  bankName          String?
  accountNumber     String?
  accountHolderName String?
  ifscCode          String?
  upiId             String?
  qrCode            String?       // QR code image URL

  status            PayLinkStatus @default(ACTIVE)

  // User
  userId            String        @db.ObjectId
  user              User          @relation(fields: [userId], references: [id])

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model PayLinkRequest {
  id                String              @id @default(auto()) @map("_id") @db.ObjectId
  applyId           String?             @unique // Format: PL{YYYYMMDD}{7-digit random}

  type              PayLinkRequestType
  fullName          String
  email             String
  country           String
  amount            Float

  // Company fields (optional, only for COMPANY type)
  companyName       String?
  website           String?

  // Pay Link created by admin
  payLink           String?

  status            PayLinkRequestStatus @default(PENDING)

  // User who created the request
  userId            String              @db.ObjectId
  user              User                @relation(fields: [userId], references: [id])

  // Admin remarks
  adminRemarks      String?

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model BlockHistory {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  reason            String?

  // User who was blocked
  userId            String    @db.ObjectId
  user              User      @relation("BlockedUser", fields: [userId], references: [id])

  // Admin/Agent who blocked
  blockedById       String    @db.ObjectId
  blockedBy         User      @relation("BlockedBy", fields: [blockedById], references: [id])

  blockedAt         DateTime  @default(now())
  unblockedAt       DateTime?
}

model CustomDomain {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId

  domain            String        @unique
  status            DomainStatus  @default(PENDING)

  // DNS verification
  dnsVerified       Boolean       @default(false)
  verificationToken String?       // Token for DNS TXT record verification

  // Agent who owns this domain
  agentId           String        @db.ObjectId
  agent             User          @relation("AgentDomains", fields: [agentId], references: [id])

  adminRemarks      String?

  approvedAt        DateTime?
  rejectedAt        DateTime?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model SiteSettings {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  domain            String    @unique
  brandName         String
  logo              String?
  favicon           String?

  // Contact
  supportEmail      String?
  supportPhone      String?

  // Social
  facebookUrl       String?
  twitterUrl        String?
  instagramUrl      String?

  // Settings
  maintenanceMode   Boolean   @default(false)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Module {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  route             String
  label             String
  icon              String

  role              UserRole
  priority          Int       @default(1000)

  isActive          Boolean   @default(true)
}

model PaymentMethod {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  name              String
  description       String?
  icon              String    @default("ðŸ’³")

  isEnabled         Boolean   @default(true)
  isDefault         Boolean   @default(false)

  sortOrder         Int       @default(0)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model GlobalSettings {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId

  // Pay Link feature toggle
  payLinkEnabled    Boolean   @default(true)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}
